<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRex | Sec-Education Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@300;400;600;800&display=swap');
        
        :root { --hacker-green: #00ff41; --bg-black: #050505; --panel: #0f0f0f; }
        body { background-color: var(--bg-black); color: #cfcfcf; font-family: 'Inter', sans-serif; overflow: hidden; }
        .hacker-font { font-family: 'Fira Code', monospace; }
        
        /* Smooth Matrix Background */
        #canvas-bg { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.12; }
        
        /* Glass UI */
        .sidebar { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(15px); border-right: 1px solid #1a1a1a; }
        .msg-user { background: #1a1a1a; border: 1px solid #333; }
        .msg-bot { background: #000; border: 1px solid #00ff4133; }
        
        .code-block { background: #000; padding: 10px; border-left: 3px solid var(--hacker-green); border-radius: 4px; margin: 10px 0; font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--hacker-green); }

        .btn-glow:hover { box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <canvas id="canvas-bg"></canvas>

    <aside class="sidebar w-full md:w-80 flex flex-col z-20">
        <div class="p-6 border-b border-zinc-900 flex justify-between items-center">
            <h1 class="text-xl font-extrabold hacker-font text-white tracking-tighter">DREX<span class="text-green-500">_SEC</span></h1>
            <span class="text-[9px] bg-red-900/20 text-red-500 px-2 py-0.5 rounded border border-red-500/30">EDU_ONLY</span>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="historyList"></div>

        <div class="p-4 border-t border-zinc-900 space-y-2">
            <button onclick="newChat()" class="w-full bg-white text-black py-2.5 rounded-lg text-xs font-black hover:bg-green-500 transition btn-glow">NEW_LAB_SESSION</button>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="openModal('settingsModal')" class="bg-zinc-900 text-zinc-400 py-2 rounded text-[10px] hacker-font hover:text-white transition">CONFIG</button>
                <button onclick="clearAllLogs()" class="bg-zinc-900 text-red-800 py-2 rounded text-[10px] hacker-font hover:text-red-500 transition">PURGE_LOGS</button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full">
        <header class="h-14 border-b border-zinc-900 bg-black/40 flex items-center justify-between px-6">
            <div class="flex items-center gap-4">
                <div class="text-[10px] hacker-font flex items-center gap-2">
                    <span class="text-zinc-600">ENGINE:</span>
                    <span id="headerModel" class="text-green-500">UNCONFIGURED</span>
                </div>
            </div>
            <div class="flex items-center gap-3 text-[10px] text-zinc-500 hacker-font">
                <i class="fas fa-terminal"></i>
                <span>LAB_ID: <span id="labId">DRX-77</span></span>
            </div>
        </header>

        <div id="chatBox" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div id="welcome" class="h-full flex flex-col items-center justify-center text-center max-w-sm mx-auto opacity-50">
                <i class="fas fa-user-secret text-4xl mb-4 text-green-500"></i>
                <h2 class="text-lg font-bold text-white mb-2">Educational Security Lab</h2>
                <p class="text-xs leading-relaxed">This environment is for learning vulnerability analysis, secure coding, and ethical network defense.</p>
            </div>
        </div>

        <footer class="p-6">
            <div class="max-w-4xl mx-auto bg-zinc-900/50 border border-zinc-800 rounded-2xl p-2 flex items-end gap-2 focus-within:border-green-600 transition shadow-2xl">
                <textarea id="userInput" rows="1" 
                    class="flex-1 bg-transparent outline-none p-3 text-sm resize-none text-white" 
                    placeholder="Enter security query or code snippet..." 
                    oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                <button onclick="processCommand()" class="bg-green-600 text-black h-11 w-11 rounded-xl font-bold hover:bg-green-400 transition flex items-center justify-center shrink-0">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
            <p class="text-center text-[9px] text-zinc-600 mt-3 hacker-font uppercase tracking-tighter">Authorization Required for Production Penetration Testing</p>
        </footer>
    </main>

    <div id="settingsModal" class="fixed inset-0 bg-black/95 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-3xl max-w-md w-full shadow-2xl">
            <h2 class="text-xl font-bold mb-6 hacker-font text-white flex items-center gap-2">
                <i class="fas fa-cogs text-green-500"></i> SYSTEM_CORE_CONFIG
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] text-zinc-500 mb-1 hacker-font uppercase">OpenRouter Key</label>
                    <input type="password" id="apiKeyInput" class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-green-500 text-sm outline-none focus:border-green-600" placeholder="sk-or-v1-...">
                </div>
                <div>
                    <label class="block text-[10px] text-zinc-500 mb-1 hacker-font uppercase">Target AI Model</label>
                    <input type="text" id="modelInput" class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-white text-sm outline-none focus:border-green-600" placeholder="e.g., google/gemini-2.0-flash-001">
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="closeModal('settingsModal')" class="flex-1 py-3 text-xs font-bold text-zinc-500">ABORT</button>
                    <button onclick="saveSettings()" class="flex-1 bg-green-600 text-black py-3 rounded-xl font-black text-xs">SAVE_INITIALIZE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chatHistory = JSON.parse(localStorage.getItem('drex_sec_history')) || [];
        let currentChat = [];
        let API_KEY = localStorage.getItem('drex_key') || '';
        let MODEL_NAME = localStorage.getItem('drex_model') || 'google/gemini-2.0-flash-001';

        window.onload = () => {
            initMatrix();
            loadSettings();
            renderHistory();
            document.getElementById('labId').innerText = 'DRX-' + Math.floor(Math.random()*900 + 100);
        };

        function loadSettings() {
            document.getElementById('apiKeyInput').value = API_KEY;
            document.getElementById('modelInput').value = MODEL_NAME;
            updateHeader();
        }

        function saveSettings() {
            API_KEY = document.getElementById('apiKeyInput').value.trim();
            MODEL_NAME = document.getElementById('modelInput').value.trim() || 'google/gemini-2.0-flash-001';
            localStorage.setItem('drex_key', API_KEY);
            localStorage.setItem('drex_model', MODEL_NAME);
            updateHeader();
            closeModal('settingsModal');
        }

        function updateHeader() {
            const display = MODEL_NAME.split('/').pop().toUpperCase();
            document.getElementById('headerModel').innerText = API_KEY ? display : 'KEY_MISSING';
        }

        async function processCommand() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text || !API_KEY) return !API_KEY ? openModal('settingsModal') : null;

            if (currentChat.length === 0) document.getElementById('chatBox').innerHTML = '';
            appendMsg('user', text);
            currentChat.push({ role: 'user', content: text });
            input.value = '';
            input.style.height = 'auto';

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: "system", content: "You are a professional Cyber Security Instructor. Provide technical, accurate, and ethical information for educational purposes only. If asked about malicious activities, redirect the user to learning defensive measures, patch management, and security auditing." },
                            ...currentChat
                        ]
                    })
                });

                const data = await response.json();
                const reply = data.choices[0].message.content;
                appendMsg('assistant', reply);
                currentChat.push({ role: 'assistant', content: reply });
                saveToHistory();
            } catch (err) {
                appendMsg('assistant', "SYSTEM_FAILURE: Could not reach Neural Grid. Verify your API Key and Model ID.");
            }
        }

        function appendMsg(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[85%] p-4 rounded-2xl text-sm ${role === 'user' ? 'msg-user text-white' : 'msg-bot text-zinc-300'}">
                    <p class="text-[9px] hacker-font mb-2 uppercase ${role === 'user' ? 'text-zinc-500' : 'text-green-500'}">${role}</p>
                    <div class="whitespace-pre-wrap">${content}</div>
                </div>
            `;
            const box = document.getElementById('chatBox');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function saveToHistory() {
            const index = chatHistory.indexOf(currentChat);
            if (index === -1) chatHistory.unshift(currentChat);
            localStorage.setItem('drex_sec_history', JSON.stringify(chatHistory));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            chatHistory.forEach((session, i) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 text-[10px] truncate text-zinc-500 hover:bg-zinc-900 rounded-lg transition border border-transparent hover:border-zinc-800 hacker-font uppercase";
                btn.innerText = `SESSION_${chatHistory.length - i}: ${session[0]?.content.substring(0, 20)}...`;
                btn.onclick = () => {
                    currentChat = session;
                    document.getElementById('chatBox').innerHTML = '';
                    session.forEach(m => appendMsg(m.role, m.content));
                };
                list.appendChild(btn);
            });
        }

        function clearAllLogs() {
            if(confirm("Permanently purge all laboratory logs?")) {
                localStorage.removeItem('drex_sec_history');
                chatHistory = [];
                newChat();
                renderHistory();
            }
        }

        function newChat() {
            currentChat = [];
            document.getElementById('chatBox').innerHTML = '<div class="h-full flex flex-col items-center justify-center opacity-20"><i class="fas fa-user-secret text-4xl mb-4 text-green-500"></i><p class="hacker-font text-xs uppercase tracking-widest">Lab Reset Success. Awaiting Input...</p></div>';
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function initMatrix() {
            const c = document.getElementById("canvas-bg");
            const ctx = c.getContext("2d");
            c.width = window.innerWidth; c.height = window.innerHeight;
            const letters = "01010101010101010101010101010101";
            const fontSize = 16;
            const columns = c.width / fontSize;
            const drops = Array(Math.floor(columns)).fill(1);
            function draw() {
                ctx.fillStyle = "rgba(0,0,0,0.05)"; ctx.fillRect(0,0,c.width,c.height);
                ctx.fillStyle = "#0F0"; ctx.font = fontSize + "px monospace";
                for(let i=0; i<drops.length; i++) {
                    const text = letters.charAt(Math.floor(Math.random()*letters.length));
                    ctx.fillText(text, i*fontSize, drops[i]*fontSize);
                    if(drops[i]*fontSize > c.height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            }
            setInterval(draw, 35);
        }
    </script>
</body>
</html>
