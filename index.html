<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRex - Hacker AI Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Hacker Theme */
        body.hacker-mode {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
        }
        body.normal-mode {
            background-color: #fff;
            color: #000;
            font-family: Arial, sans-serif;
        }
        /* Matrix-like loading animation */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .matrix {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .matrix-column {
            position: absolute;
            top: -100%;
            white-space: nowrap;
            animation: fall 10s linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(100vh); }
        }
    </style>
</head>
<body class="hacker-mode min-h-screen flex flex-col">
    <!-- Loading Animation -->
    <div id="loading" class="matrix">
        <div style="position: absolute; color: #0f0; font-size: 2rem;">Initializing DRex Hacker Interface...</div>
        <!-- Generate matrix columns dynamically in JS -->
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-gray-900 p-4 flex flex-col fixed h-full overflow-y-auto">
        <h1 class="text-2xl font-bold mb-4">DRex</h1>
        <button id="new-chat" class="bg-green-600 text-black px-4 py-2 mb-4 rounded">New Chat</button>
        <input id="chat-search" type="text" placeholder="Search chats..." class="bg-gray-800 p-2 mb-4 rounded text-white">
        <ul id="chat-history" class="flex-grow"></ul>
        <button id="prompt-library-btn" class="bg-gray-700 px-4 py-2 mb-2 rounded">Prompt Library</button>
        <button id="settings-btn" class="bg-gray-700 px-4 py-2 mb-2 rounded">Settings</button>
        <button id="mode-toggle" class="bg-red-600 px-4 py-2 rounded">Switch to Normal Mode</button>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-grow ml-64 p-4 flex flex-col">
        <div id="chat-container" class="flex-grow overflow-y-auto mb-4"></div>
        <div id="typing-indicator" class="hidden text-green-500 mb-2">DRex is typing...</div>
        <div class="flex items-center">
            <input id="user-input" type="text" placeholder="Type your message..." class="flex-grow p-4 bg-gray-800 rounded-l text-white" 
                   ondrop="handleDrop(event)" ondragover="event.preventDefault()">
            <button id="voice-btn" class="bg-gray-700 p-4">ðŸŽ¤</button>
            <button id="upload-btn" class="bg-gray-700 p-4">ðŸ“Ž</button>
            <input id="file-input" type="file" class="hidden">
            <button id="send-btn" class="bg-green-600 p-4 rounded-r">Send</button>
        </div>
        <div id="token-counter" class="text-sm mt-2">Tokens used: 0 | Credits: Loading...</div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded w-96">
            <h2 class="text-xl mb-4">Settings</h2>
            <label class="block mb-2">OpenRouter API Key:</label>
            <input id="api-key" type="text" class="w-full p-2 bg-gray-700 mb-4">
            <label class="block mb-2">Custom Model Name (e.g., openai/gpt-4o for normal, nousresearch/nous-hermes2 for uncensored):</label>
            <input id="model-name" type="text" class="w-full p-2 bg-gray-700 mb-4" value="openai/gpt-4o">
            <button id="save-settings" class="bg-green-600 px-4 py-2">Save</button>
            <button id="close-settings" class="bg-red-600 px-4 py-2 ml-2">Close</button>
        </div>
    </div>

    <!-- Prompt Library Modal -->
    <div id="prompt-library-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded w-96">
            <h2 class="text-xl mb-4">Prompt Library</h2>
            <ul id="prompt-list">
                <!-- Dynamically added in JS -->
            </ul>
            <button id="close-library" class="bg-red-600 px-4 py-2 mt-4">Close</button>
        </div>
    </div>

    <script>
        // Prevent blank page by placing script at end

        // Constants
        const API_BASE = 'https://openrouter.ai/api/v1';
        let apiKey = localStorage.getItem('apiKey') || '';
        let model = localStorage.getItem('model') || 'openai/gpt-4o';
        let chats = JSON.parse(localStorage.getItem('chats')) || [];
        let currentChatId = null;
        let isHackerMode = true;
        let credits = 0;
        let totalTokens = 0;
        let unreadChats = new Set();

        // Default Prompt Library
        const promptLibrary = [
            "Explain quantum computing like I'm 5.",
            "Write a hacker script to simulate matrix rain.",
            "Generate a secure password.",
            "Tell me a dark web story.",
            "How to build an AI like DRex."
        ];

        // Matrix Animation on Load
        function initMatrix() {
            const matrix = document.querySelector('.matrix');
            for (let i = 0; i < 50; i++) {
                const column = document.createElement('div');
                column.classList.add('matrix-column');
                column.style.left = `${Math.random() * 100}%`;
                column.style.animationDuration = `${Math.random() * 5 + 5}s`;
                column.style.animationDelay = `${Math.random() * 5}s`;
                column.style.opacity = Math.random();
                for (let j = 0; j < 20; j++) {
                    column.innerHTML += String.fromCharCode(0x30A0 + Math.random() * 96) + ' ';
                }
                matrix.appendChild(column);
            }
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 3000); // 3s animation
        }

        // Load Chats
        function loadChats() {
            const history = document.getElementById('chat-history');
            history.innerHTML = '';
            chats.forEach((chat, index) => {
                const li = document.createElement('li');
                li.classList.add('p-2', 'hover:bg-gray-700', 'cursor-pointer', 'relative');
                li.textContent = chat.title || `Chat ${index + 1}`;
                li.dataset.id = index;
                if (unreadChats.has(index)) {
                    const badge = document.createElement('span');
                    badge.classList.add('absolute', 'right-2', 'bg-red-500', 'text-xs', 'px-2', 'rounded-full');
                    badge.textContent = 'New';
                    li.appendChild(badge);
                }
                li.addEventListener('click', () => loadChat(index));
                history.appendChild(li);
            });
        }

        // Load Specific Chat
        function loadChat(id) {
            currentChatId = id;
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
            chats[id].messages.forEach(msg => addMessage(msg.content, msg.role === 'assistant'));
            unreadChats.delete(id);
            loadChats();
            container.scrollTop = container.scrollHeight;
        }

        // Add Message to Chat
        function addMessage(content, isAI = false) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.classList.add('mb-4', isAI ? 'text-left' : 'text-right');
            const bubble = document.createElement('div');
            bubble.classList.add('inline-block', 'p-4', 'rounded', isAI ? 'bg-gray-700' : 'bg-green-600');
            bubble.textContent = content;
            div.appendChild(bubble);
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message || !apiKey) return alert('Set API Key in Settings');
            addMessage(message, false);
            if (currentChatId === null) createNewChat();
            chats[currentChatId].messages.push({ role: 'user', content: message });
            saveChats();
            input.value = '';

            document.getElementById('typing-indicator').classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: chats[currentChatId].messages
                    })
                });
                const data = await response.json();
                const aiMessage = data.choices[0].message.content;
                addMessage(aiMessage, true);
                chats[currentChatId].messages.push({ role: 'assistant', content: aiMessage });
                saveChats();

                // Update Tokens
                totalTokens += data.usage.total_tokens;
                updateTokenCounter();
            } catch (error) {
                addMessage('Error: ' + error.message, true);
            } finally {
                document.getElementById('typing-indicator').classList.add('hidden');
            }
        }

        // Create New Chat
        function createNewChat() {
            const newChat = { title: 'New Chat', messages: [] };
            chats.push(newChat);
            currentChatId = chats.length - 1;
            unreadChats.add(currentChatId); // Mark as unread initially? No, since creating it.
            loadChats();
            loadChat(currentChatId);
        }

        // Save Chats to LocalStorage
        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        // Fetch Credits
        async function fetchCredits() {
            if (!apiKey) return;
            try {
                const response = await fetch(`${API_BASE}/auth/key`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                const data = await response.json();
                credits = data.balance || 0; // Assuming balance is in credits
                updateTokenCounter();
            } catch {}
        }

        // Update Token Counter
        function updateTokenCounter() {
            document.getElementById('token-counter').textContent = `Tokens used: ${totalTokens} | Credits: ${credits}`;
        }

        // Voice Input
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.onresult = (event) => {
            document.getElementById('user-input').value = event.results[0][0].transcript;
        };
        recognition.onerror = () => alert('Voice recognition error');

        // File Upload
        document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', handleFile);
        function handleDrop(e) {
            e.preventDefault();
            handleFile({ target: { files: e.dataTransfer.files } });
        }
        async function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.type.startsWith('image/')) {
                // Base64 for vision models
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const base64 = ev.target.result;
                    // Append to message as data URI for OpenRouter vision
                    const currentInput = document.getElementById('user-input').value;
                    document.getElementById('user-input').value = currentInput + ' [Image: ' + base64 + ']';
                };
                reader.readAsDataURL(file);
            } else {
                // Text file
                const text = await file.text();
                const currentInput = document.getElementById('user-input').value;
                document.getElementById('user-input').value = currentInput + ' [File: ' + text + ']';
            }
        }

        // Prompt Library
        function loadPromptLibrary() {
            const list = document.getElementById('prompt-list');
            list.innerHTML = '';
            promptLibrary.forEach(prompt => {
                const li = document.createElement('li');
                li.classList.add('p-2', 'hover:bg-gray-700', 'cursor-pointer');
                li.textContent = prompt;
                li.addEventListener('click', () => {
                    document.getElementById('user-input').value = prompt;
                    document.getElementById('prompt-library-modal').classList.add('hidden');
                });
                list.appendChild(li);
            });
        }

        // Chat Search
        document.getElementById('chat-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const history = document.getElementById('chat-history');
            Array.from(history.children).forEach(li => {
                li.style.display = li.textContent.toLowerCase().includes(query) ? 'block' : 'none';
            });
        });

        // Mode Toggle
        function toggleMode() {
            isHackerMode = !isHackerMode;
            document.body.classList.toggle('hacker-mode', isHackerMode);
            document.body.classList.toggle('normal-mode', !isHackerMode);
            document.getElementById('mode-toggle').textContent = isHackerMode ? 'Switch to Normal Mode' : 'Switch to Hacker Mode';
            // Switch model for "uncensored"
            model = isHackerMode ? 'nousresearch/nous-hermes2' : 'openai/gpt-4o';
            localStorage.setItem('model', model);
        }

        // Event Listeners
        document.getElementById('new-chat').addEventListener('click', createNewChat);
        document.getElementById('settings-btn').addEventListener('click', () => document.getElementById('settings-modal').classList.remove('hidden'));
        document.getElementById('close-settings').addEventListener('click', () => document.getElementById('settings-modal').classList.add('hidden'));
        document.getElementById('save-settings').addEventListener('click', () => {
            apiKey = document.getElementById('api-key').value;
            model = document.getElementById('model-name').value;
            localStorage.setItem('apiKey', apiKey);
            localStorage.setItem('model', model);
            fetchCredits();
            document.getElementById('settings-modal').classList.add('hidden');
        });
        document.getElementById('prompt-library-btn').addEventListener('click', () => {
            loadPromptLibrary();
            document.getElementById('prompt-library-modal').classList.remove('hidden');
        });
        document.getElementById('close-library').addEventListener('click', () => document.getElementById('prompt-library-modal').classList.add('hidden'));
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        document.getElementById('voice-btn').addEventListener('click', () => recognition.start());
        document.getElementById('mode-toggle').addEventListener('click', toggleMode);

        // Init
        initMatrix();
        loadChats();
        if (chats.length > 0) loadChat(0);
        document.getElementById('api-key').value = apiKey;
        document.getElementById('model-name').value = model;
        fetchCredits();
        updateTokenCounter();
    </script>
</body>
</html>
