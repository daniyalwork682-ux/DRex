<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRex - Universal AI Chat Interface</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            neon: '#00ff9c'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-950 text-gray-100 h-screen overflow-hidden">

<div class="flex h-full">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-gray-900 border-r border-gray-800 flex flex-col">
    <div class="p-4 flex items-center justify-between border-b border-gray-800">
      <h1 class="text-xl font-bold text-neon">DRex</h1>
      <span id="unreadBadge" class="hidden text-xs bg-red-600 px-2 py-0.5 rounded-full">New</span>
    </div>

    <div class="p-3">
      <input id="searchChats" type="text" placeholder="Search chats..." class="w-full bg-gray-800 rounded px-3 py-2 text-sm outline-none">
    </div>

    <div id="chatList" class="flex-1 overflow-y-auto px-2 space-y-2"></div>

    <div class="p-3 border-t border-gray-800 flex gap-2">
      <button id="newChatBtn" class="flex-1 bg-neon text-black rounded px-3 py-2 text-sm font-semibold">+ New</button>
      <button id="settingsBtn" class="bg-gray-800 rounded px-3 py-2 text-sm">‚öô</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col">

    <!-- Top Bar -->
    <div class="p-3 border-b border-gray-800 flex items-center justify-between">
      <div class="flex gap-2 items-center">
        <span class="text-sm text-gray-400">Model:</span>
        <span id="modelLabel" class="text-sm text-neon">not set</span>
      </div>
      <div class="flex gap-2">
        <button id="toggleModeBtn" class="bg-gray-800 px-3 py-1 rounded text-sm">üßë‚Äçüíª Hacker Mode</button>
        <button id="promptBtn" class="bg-gray-800 px-3 py-1 rounded text-sm">üìö Prompts</button>
      </div>
    </div>

    <!-- Chat Area -->
    <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

    <!-- Typing Indicator -->
    <div id="typingIndicator" class="hidden px-4 text-sm text-gray-400">DRex is typing...</div>

    <!-- Bottom Bar -->
    <div class="p-3 border-t border-gray-800">
      <div class="flex gap-2 items-center">
        <input type="file" id="fileInput" class="hidden" />
        <button id="fileBtn" class="bg-gray-800 px-3 py-2 rounded">üìé</button>
        <button id="voiceBtn" class="bg-gray-800 px-3 py-2 rounded">üé§</button>
        <input id="userInput" type="text" placeholder="Type your message..." class="flex-1 bg-gray-800 rounded px-3 py-2 outline-none" />
        <button id="sendBtn" class="bg-neon text-black px-4 py-2 rounded font-semibold">Send</button>
      </div>
      <div class="mt-2 flex justify-between text-xs text-gray-400">
        <span id="tokenCounter">Tokens: 0</span>
        <span id="creditCounter">Credits: 0.00</span>
      </div>
    </div>

  </main>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center">
  <div class="bg-gray-900 p-6 rounded w-96 space-y-4">
    <h2 class="text-lg font-bold text-neon">Settings</h2>
    <div>
      <label class="text-sm text-gray-400">OpenRouter API Key</label>
      <input id="apiKeyInput" type="password" class="w-full bg-gray-800 rounded px-3 py-2 mt-1" />
    </div>
    <div>
      <label class="text-sm text-gray-400">Model Name</label>
      <input id="modelInput" type="text" placeholder="e.g. openai/gpt-4o-mini" class="w-full bg-gray-800 rounded px-3 py-2 mt-1" />
    </div>
    <div class="flex justify-end gap-2">
      <button id="closeSettings" class="bg-gray-700 px-3 py-2 rounded">Cancel</button>
      <button id="saveSettings" class="bg-neon text-black px-3 py-2 rounded font-semibold">Save</button>
    </div>
  </div>
</div>

<!-- Prompts Modal -->
<div id="promptModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center">
  <div class="bg-gray-900 p-6 rounded w-96 space-y-3">
    <h2 class="text-lg font-bold text-neon">Prompt Library</h2>
    <div class="space-y-2">
      <button class="promptItem w-full text-left bg-gray-800 p-2 rounded">Explain this like I'm 5</button>
      <button class="promptItem w-full text-left bg-gray-800 p-2 rounded">Fix bugs in this code</button>
      <button class="promptItem w-full text-left bg-gray-800 p-2 rounded">Write professional email</button>
      <button class="promptItem w-full text-left bg-gray-800 p-2 rounded">Summarize this text</button>
    </div>
    <div class="flex justify-end">
      <button id="closePrompt" class="bg-gray-700 px-3 py-2 rounded">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   State & Storage
========================= */
let chats = JSON.parse(localStorage.getItem("drex_chats") || "[]");
let currentChatId = null;
let apiKey = localStorage.getItem("drex_apiKey") || "";
let modelName = localStorage.getItem("drex_model") || "";

const chatList = document.getElementById("chatList");
const chatArea = document.getElementById("chatArea");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const newChatBtn = document.getElementById("newChatBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settingsModal = document.getElementById("settingsModal");
const saveSettings = document.getElementById("saveSettings");
const closeSettings = document.getElementById("closeSettings");
const apiKeyInput = document.getElementById("apiKeyInput");
const modelInput = document.getElementById("modelInput");
const modelLabel = document.getElementById("modelLabel");
const typingIndicator = document.getElementById("typingIndicator");
const tokenCounter = document.getElementById("tokenCounter");
const creditCounter = document.getElementById("creditCounter");
const searchChats = document.getElementById("searchChats");
const unreadBadge = document.getElementById("unreadBadge");
const toggleModeBtn = document.getElementById("toggleModeBtn");
const promptBtn = document.getElementById("promptBtn");
const promptModal = document.getElementById("promptModal");
const closePrompt = document.getElementById("closePrompt");
const fileBtn = document.getElementById("fileBtn");
const fileInput = document.getElementById("fileInput");
const voiceBtn = document.getElementById("voiceBtn");

let hackerMode = true;

/* =========================
   UI Helpers
========================= */
function saveChats() {
  localStorage.setItem("drex_chats", JSON.stringify(chats));
}

function renderChatList(filter = "") {
  chatList.innerHTML = "";
  chats
    .filter(c => c.title.toLowerCase().includes(filter.toLowerCase()))
    .forEach(chat => {
      const btn = document.createElement("button");
      btn.className = "w-full text-left bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm";
      btn.textContent = chat.title;
      btn.onclick = () => loadChat(chat.id);
      chatList.appendChild(btn);
    });
}

function renderMessages(chat) {
  chatArea.innerHTML = "";
  chat.messages.forEach(m => {
    const div = document.createElement("div");
    div.className = m.role === "user"
      ? "bg-blue-600/20 p-3 rounded self-end max-w-xl ml-auto"
      : "bg-gray-800 p-3 rounded max-w-xl";
    div.textContent = m.content;
    chatArea.appendChild(div);
  });
  chatArea.scrollTop = chatArea.scrollHeight;
}

function newChat() {
  const id = Date.now().toString();
  const chat = { id, title: "New Chat", messages: [] };
  chats.unshift(chat);
  currentChatId = id;
  saveChats();
  renderChatList();
  renderMessages(chat);
}

function loadChat(id) {
  const chat = chats.find(c => c.id === id);
  if (!chat) return;
  currentChatId = id;
  renderMessages(chat);
}

/* =========================
   API Call
========================= */
async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;

  if (!currentChatId) newChat();

  const chat = chats.find(c => c.id === currentChatId);
  chat.messages.push({ role: "user", content: text });
  if (chat.title === "New Chat") chat.title = text.slice(0, 30);
  userInput.value = "";
  renderChatList();
  renderMessages(chat);
  saveChats();

  typingIndicator.classList.remove("hidden");

  if (!apiKey || !modelName) {
    chat.messages.push({ role: "assistant", content: "‚ö†Ô∏è Please set API Key and Model in Settings." });
    typingIndicator.classList.add("hidden");
    renderMessages(chat);
    return;
  }

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + apiKey
      },
      body: JSON.stringify({
        model: modelName,
        messages: chat.messages
      })
    });

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "No response.";
    chat.messages.push({ role: "assistant", content: reply });

    // Rough token estimate
    const tokens = Math.round((JSON.stringify(chat.messages).length) / 4);
    tokenCounter.textContent = "Tokens: " + tokens;
    creditCounter.textContent = "Credits: " + (tokens * 0.000002).toFixed(4);

    unreadBadge.classList.remove("hidden");
    setTimeout(() => unreadBadge.classList.add("hidden"), 2000);

    saveChats();
    renderMessages(chat);
  } catch (e) {
    chat.messages.push({ role: "assistant", content: "‚ùå Error: " + e.message });
    renderMessages(chat);
  } finally {
    typingIndicator.classList.add("hidden");
  }
}

/* =========================
   Events
========================= */
sendBtn.onclick = sendMessage;
userInput.addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

newChatBtn.onclick = newChat;

settingsBtn.onclick = () => {
  apiKeyInput.value = apiKey;
  modelInput.value = modelName;
  settingsModal.classList.remove("hidden");
};

closeSettings.onclick = () => settingsModal.classList.add("hidden");

saveSettings.onclick = () => {
  apiKey = apiKeyInput.value.trim();
  modelName = modelInput.value.trim();
  localStorage.setItem("drex_apiKey", apiKey);
  localStorage.setItem("drex_model", modelName);
  modelLabel.textContent = modelName || "not set";
  settingsModal.classList.add("hidden");
};

searchChats.oninput = () => renderChatList(searchChats.value);

toggleModeBtn.onclick = () => {
  hackerMode = !hackerMode;
  document.body.classList.toggle("bg-gray-950");
  document.body.classList.toggle("bg-gray-100");
  toggleModeBtn.textContent = hackerMode ? "üßë‚Äçüíª Hacker Mode" : "üôÇ Normal Mode";
};

promptBtn.onclick = () => promptModal.classList.remove("hidden");
closePrompt.onclick = () => promptModal.classList.add("hidden");
document.querySelectorAll(".promptItem").forEach(btn => {
  btn.onclick = () => {
    userInput.value = btn.textContent;
    promptModal.classList.add("hidden");
    userInput.focus();
  };
});

fileBtn.onclick = () => fileInput.click();
fileInput.onchange = () => {
  if (fileInput.files.length) {
    userInput.value += " [Attached file: " + fileInput.files[0].name + "]";
  }
};

// Voice Input
if ("webkitSpeechRecognition" in window) {
  const rec = new webkitSpeechRecognition();
  rec.lang = "en-US";
  rec.onresult = e => {
    userInput.value += " " + e.results[0][0].transcript;
  };
  voiceBtn.onclick = () => rec.start();
} else {
  voiceBtn.onclick = () => alert("Voice input not supported in this browser.");
}

/* =========================
   Init
========================= */
renderChatList();
if (chats.length) {
  loadChat(chats[0].id);
}
modelLabel.textContent = modelName || "not set";
</script>

</body>
</html>
